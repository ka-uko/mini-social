{# templates/partials/_comment.html #}
{% with level=level|default:0 %}
  <div class="{% if level > 0 %}ms-4 border-start ps-3 py-2 mb-2{% else %}border rounded p-2 mb-2{% endif %}">
    <div class="d-flex justify-content-between">
      <strong>
        {% if c.author and c.author.username %}
          <a href="{% url 'profile' c.author.username %}" class="text-decoration-none">
            @{{ c.author.username }}
          </a>
        {% else %}
          @{{ c.author }}
        {% endif %}
      </strong>
      <small class="text-muted">{{ c.created_at|date:"d.m.Y H:i" }}</small>
    </div>

    <div class="mb-1">{{ c.text }}</div>

    <div class="d-flex gap-2 flex-wrap">
      {% if user.is_authenticated %}
        <button class="btn btn-sm btn-outline-primary"
                type="button"
                data-bs-toggle="collapse"
                data-bs-target="#reply-{{ c.id }}">
          Ответить
        </button>
      {% endif %}

      {% if user.is_authenticated and user == c.author %}
        <a class="btn btn-sm btn-outline-warning"
           href="{% url 'comment_edit' c.pk %}?next={{ request.get_full_path|urlencode }}">Изменить</a>
        <form method="post" action="{% url 'comment_delete' c.pk %}" class="d-inline">
          {% csrf_token %}
          <input type="hidden" name="next" value="{{ request.get_full_path }}">
          <button class="btn btn-sm btn-outline-danger">Удалить</button>
        </form>
      {% endif %}
    </div>

    {% if user.is_authenticated %}
      <div class="collapse mt-2" id="reply-{{ c.id }}">
        <form method="post" action="{% url 'add_reply' c.id %}">
          {% csrf_token %}
          <div class="input-group">
            <input type="text" name="text" class="form-control" placeholder="Ваш ответ...">
            <input type="hidden" name="next" value="{{ request.get_full_path }}">
            <button class="btn btn-primary">Ответить</button>
          </div>
        </form>
      </div>
    {% endif %}
  </div>

  {# рекурсивно выводим всех детей #}
  {% for child in c.replies.all %}
    {% include "partials/_comment.html" with c=child level=level|add:1 %}
  {% endfor %}
{% endwith %}
